# MUD游戏框架设计（更新版）

基于HIT框架，我们需要设计一个独立的MUD（Multi-User Dungeon）游戏框架，并在合适的地方对接HIT框架。为了确保设计的清晰和可维护性，我们将严格分离MUD框架和HIT框架的设计，只在必要的地方进行交互。客户端将使用TypeScript编写的网页，以支持联机功能。

**补充设计：**

- **交互面板模块：** 不像传统MUD一样全靠命令输入，我们将设计一个交互面板，上面会实时出现分类的按钮，点击可以自动发送指令。例如移动、周围有交互物时的交互选项、距离内有人时的社交选项和动作选项。
- **HIT框架：** HIT（Hybrid Intelligence Toolkit）是一个先进的TypeScript框架，用于在多个平台（包括网页应用、Unity、虚幻引擎和Godot）上模拟个体AI代理。HIT采用了AI代理的三区域管理方法：
  - **幕后区：** AI代理在玩家视野之外运作的区域。
  - **台前区：** AI代理可见并与玩家进行间接互动的区域。
  - **交互区：** AI代理与玩家直接互动的区域。
  
这种分区方法不仅能优化资源分配，还能实现复杂的行为模式。在幕后区和台前区使用效用AI和状态机，而在交互区则利用大型语言模型实现丰富的互动体验。

## 一、架构概述

### 1.1 总体架构

- **客户端（Client）：** TypeScript网页应用，负责与用户交互并通过网络与服务器通信。
- **服务器（Server）：** MUD游戏服务器，处理游戏逻辑、管理游戏状态。
- **HIT框架接口模块：** 位于服务器端，负责与HIT框架交互，实现NPC的行为和互动。

### 1.2 模块划分

- **网络模块：** 处理客户端和服务器之间的通信。
- **游戏逻辑模块：** 处理游戏的核心逻辑，包括角色、地图、物品、NPC等。
- **数据持久化模块：** 管理游戏数据的存储和读取。
- **交互面板模块：** 客户端的UI模块，提供可点击的交互选项。
- **HIT框架接口模块：** 封装与HIT框架的交互，管理AI代理。

## 二、详细设计

### 2.1 客户端设计

- **技术栈：** TypeScript、Vue.js、WebSocket、Canvas/WebGL。
- **功能：**
  - 用户登录/注册。
  - 命令输入和显示游戏反馈。
  - 地图和角色的图形显示。
  - **交互面板，提供实时的交互按钮。**
  - 与服务器进行实时通信。

#### 2.1.1 交互面板模块

- **目的：** 提供可视化的交互界面，减少对命令行输入的依赖，提升用户体验。

- **功能设计：**

  - **移动按钮：**
    - 根据角色当前位置和地图，动态显示可移动的方向按钮（上、下、左、右等）。
    - 点击按钮后，自动向服务器发送移动指令。

  - **交互选项：**
    - 当角色周围有可交互的物体（如NPC、物品、场景元素）时，显示相应的交互按钮。
    - 交互按钮分类显示，如“拾取”、“对话”、“攻击”等。
    - 点击按钮后，自动向服务器发送对应的交互指令。

  - **社交与动作选项：**
    - 当附近有其他玩家或NPC时，显示社交选项按钮，如“私聊”等。
    - 动作选项包括表达情感的动作，如“挥手”、“点头”、“鼓掌”等。
    - 点击按钮后，自动向服务器发送对应的指令。

- **UI设计：**

  - **动态更新：**
    - 交互面板根据游戏状态实时更新，显示当前可用的选项。
    - 面板位置和样式需兼顾美观和实用性，不遮挡主要游戏画面。

  - **可扩展性：**
    - 允许根据新增功能或特殊事件添加新的按钮和选项。

#### 2.1.2 地图与角色显示

- **地图设计：**
  - 使用2:3比例的卡牌图块（Tile）组成地图。
  - 每个图块代表一个地图单元，可以是房间、道路、场景等。
  - 使用Canvas或WebGL绘制地图，实现平滑的滚动和缩放。

- **角色立绘：**
  - 角色形象使用2:3比例的立绘展示。
  - 支持角色的基本动作和表情变化。
  - 角色在地图上的位置与服务器同步。

### 2.2 服务器设计

服务器采用模块化设计，确保各部分职责清晰。

#### 2.2.1 网络模块

- **协议：** 使用WebSocket协议，实现全双工通信。
- **功能：**
  - 处理客户端的连接、断开。
  - 解析客户端发送的消息。
  - 向客户端发送游戏状态更新。

#### 2.2.2 游戏逻辑模块

- **角色模块（Player）：**
  - 属性：名称、状态、位置、属性值等。
  - 方法：移动、交互、使用物品等。

- **NPC模块（AI Agent）：**
  - 由HIT框架生成和管理的AI代理。
  - **AI代理行为：**
    - **幕后区：** NPC在玩家看不见的地方进行逻辑处理，节省资源。
    - **台前区：** NPC在玩家视野内，进行HIT框架驱动的基本的行动
    - **交互区：** 当玩家与NPC直接交互时，HIT框架驱动，利用大型语言模型，提供丰富的交流体验。

- **地图模块（Map）：**

  ##### 地图设计

  - **地图结构：**
    - 地图由2:3比例的卡牌图块组成，每个图块代表一个位置（Location）。
    - 区分**大场景**和**房间**：
      - **大场景（Scene）：** 由多个房间组成，如城市、森林等。
      - **房间（Room）：** 少量图块组成的基本空间，如建筑内部、洞穴的不同区域等。

  - **图块（Tile）：**
    - 属性：位置坐标、类型（如草地、道路、建筑）、连接信息等。
    - 方法：获取相邻图块、判断可通行性等。

  - **地图管理：**
    - 管理所有地图数据。
    - 提供接口供角色和NPC模块调用，实现角色的移动和地图交互。

- **物品模块（Item）：**
  - 属性：名称、类型、效果等。
  - 方法：拾取、使用、丢弃。

- **交互模块：**
  - 处理玩家之间、玩家与环境的交互。
  - 支持聊天触发等功能。
  - 与交互面板模块协同，提供交互选项。

#### 2.2.3 数据持久化模块

- **数据库：** 使用MongoDB或其他NoSQL数据库。
- **功能：**
  - 存储玩家信息、游戏状态。
  - 存储地图、NPC和物品等静态数据。
  - 提供数据的读写接口。

### 2.3 HIT框架接口模块

- **职责：**
  - 管理NPC的生成、行为和状态。
  - 根据AI代理的三区域管理方法，优化NPC的资源和行为。

- **三区域管理：**

  - **幕后区（后台）**
    - NPC在玩家视野之外，由效用AI和状态机驱动，进行简化的逻辑处理。
    - 主要处理NPC的全局行动，如移动到某个区域、完成任务等。

  - **台前区（前台）**
    - NPC在玩家可见范围内，但未直接交互。
    - NPC表现出基本的行为，如巡逻、闲逛、与环境互动。
    - 行为由效用AI和状态机控制，具有随机性和多样性。

  - **交互区（互动）**
    - 当玩家与NPC直接互动时，切换到交互区。
    - 利用大型语言模型，为NPC提供自然语言交流、复杂决策等功能。
    - 提供更真实和丰富的互动体验。

- **与游戏逻辑模块的交互：**
  - NPC的状态和行为由HIT框架管理，游戏逻辑模块需要与HIT框架接口模块进行通信，获取NPC的当前状态和行为指令。
  - 当玩家进入NPC的交互区时，通知HIT框架进行行为模式的切换。

## 三、联机支持

### 3.1 实时通信

- 使用WebSocket实现服务器与客户端的实时通信，支持多用户同时在线。

### 3.2 并发处理

- 服务器端采用异步非阻塞的方式处理请求，提高并发性能。
- 使用事件驱动模型（如Node.js的事件循环）来管理连接。

## 四、技术选型

### 4.1 服务器端

- **语言：** TypeScript（Node.js环境）
- **框架：** 使用Koa（Node.js）搭建服务器。
- **WebSocket库：** `ws`或`socket.io`（Node.js）
- **HIT框架：** 引入HIT框架的TypeScript版本，用于NPC的管理。

### 4.2 客户端

- **语言：** TypeScript。
- **前端框架：** Vue.js。
- **绘图技术：** Canvas或WebGL。
- **WebSocket支持：** 浏览器原生WebSocket或使用封装库。

## 五、对接HIT框架的细节

### 5.1 HIT框架概述

- **HIT（Hybrid Intelligence Toolkit）：** 专门设计用于在多个平台上模拟个体AI代理。

- **三区域管理方法：**
  - **幕后区：** AI代理在玩家视野之外，进行简化的逻辑处理。
  - **台前区：** AI代理可见，进行基本的行为和间接互动。
  - **交互区：** AI代理与玩家直接互动，提供高级的互动体验。

### 5.2 错误处理

- 处理与HIT框架交互时可能出现的错误，例如网络异常、模型加载失败等，确保不影响MUD框架的稳定性。

## 六、数据流程

1. **用户登录：**
   - 客户端发送登录请求。
   - 服务器接收请求，调用`HITInterface.login`进行用户认证。
   - 认证成功后，建立用户会话，允许用户进行游戏操作。

2. **游戏操作：**
   - 用户在客户端通过交互面板点击按钮或输入命令。
   - 客户端通过WebSocket将操作指令发送给服务器。
   - 服务器解析指令，更新游戏状态。
   - 若涉及地图、角色位置或NPC互动，通知相关模块进行处理。
   - 对于NPC互动，可能涉及与HIT框架的通信。
   - 服务器将结果返回给客户端。

3. **NPC行为：**
   - 服务器根据玩家的位置，通知HIT框架调整NPC的行为模式（幕后区、台前区、交互区）。
   - HIT框架生成NPC的行为指令，服务器接收并更新NPC状态。
   - 若NPC需要与玩家互动，服务器将相应信息发送给客户端。

## 七、安全性考虑

- **输入校验：** 对客户端发送的所有数据进行校验，防止注入攻击和非法操作。
- **权限控制：** 使用用户的权限信息，限制玩家只能执行其权限范围内的操作。
- **数据加密：** 使用HTTPS和加密的WebSocket（WSS）协议，确保数据传输的安全性。

## 八、地图和角色设计细节

### 8.1 地图设计

- **图块（Tile）的实现：**
  - 每个图块采用2:3的比例，符合卡牌的视觉效果。
  - 图块可以包含不同的地形和功能，如草地、河流、道路、建筑物等。
  - 图块之间通过边界连接，定义角色可以移动的路径。

- **地图布局：**
  - **大场景（Scene）：**
    - 包含多个相连的图块，形成开放的地图区域。
    - 适用于户外环境，如城市广场、森林等。
  - **房间（Room）：**
    - 由一个或几个图块组成，用于表示室内或封闭空间。
    - 进入房间需要通过特定的入口，可能触发特殊的事件或交互。

- **地图加载：**
  - 客户端根据角色的位置，动态加载和卸载附近的地图数据，减少资源消耗。
  - 采用区域划分，预加载玩家可能前往的区域，提升流畅度。

### 8.2 角色立绘

- **角色形象：**
  - 使用2:3比例的立绘，保证与地图图块的比例协调。
  - 立绘可以根据角色的种族、职业、装备等进行个性化展示。

- **动作和动画：**
  - 支持基本的移动、攻击、施法等动作动画。
  - 动画采用切换立绘图片的方式。

- **状态展示：**
  - 角色头顶显示昵称、生命值等重要信息。
  - 特殊状态（如中毒、眩晕）通过emoji进行展示。

### 8.3 交互体验

- **交互面板：**
  - 动态显示当前可用的交互按钮，让玩家快速选择操作。
  - 面板设计简洁明了，避免信息过载。

- **地图反馈：**
  - 当玩家移动时，地图会平滑滚动，始终保持角色在视野内。
  - 特殊地点或物品会有突出显示，提示玩家进行交互。

## 九、示例场景

- **场景一：玩家遇到NPC**

  1. 玩家角色移动到某个位置，附近有一个NPC。
  2. 客户端的交互面板显示“对话”等按钮。
  3. 玩家点击“对话”按钮，客户端发送指令到服务器。
  4. 服务器通知HIT框架，切换NPC到交互区。
  5. HIT框架生成NPC的对话内容，通过服务器发送给客户端。
  6. 玩家看到NPC的对话内容，可以选择回复。

- **场景二：玩家拾取物品**

  1. 玩家在地图上看到一个可拾取的物品。
  2. 交互面板显示“拾取”按钮。
  3. 玩家点击“拾取”按钮，客户端发送指令到服务器。
  4. 服务器验证拾取条件，将物品添加到玩家的背包。
  5. 服务器通知客户端更新背包和地图，移除物品显示。

## 十、总结

通过上述设计，我们实现了一个独立的MUD游戏框架，融合了现代游戏的交互方式和传统MUD的深度。交互面板模块的引入，使得玩家可以通过点击按钮快速进行操作，提升了可玩性和用户体验。

HIT框架作为NPC管理的核心，采用三区域管理方法，实现了资源优化和丰富的AI行为。在幕后区和台前区，NPC使用效用AI和状态机进行高效的行为控制；在交互区，利用大型语言模型提供生动的互动。

客户端使用TypeScript网页应用，实现了精美的地图和角色展示，以及实时的交互功能。服务器端通过模块化设计，确保了各部分的职责清晰，并成功地与HIT框架对接，实现了AI代理的管理。

总体而言，此次设计在保证与HIT框架严格分离的同时，充分利用了其优势，为玩家提供了沉浸式的游戏体验。